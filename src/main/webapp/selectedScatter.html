<!DOCTYPE html>
<html lang="en">
<head>
    <title>PINPOINT</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap-responsive.css" rel="stylesheet"/>
    <link href="/common/css/hippo/hippo.css" rel="stylesheet"/>
    <link href="/common/css/hippo/sorttable.css" rel="stylesheet"/>
    <link href="/common/css/hippo/scatter.css" rel="stylesheet"/>
    <link href="/common/css/datepicker.css" rel="stylesheet"/>
    <link href="/select2/select2-customized.css" rel="stylesheet"/>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<!-- commons -->    
    <script type="text/javascript" src="/common/js/jquery/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/common/js/jquery/jquery-ui-1.10.2.js"></script>
    
    <script type="text/javascript" src="/select2/select2.js"></script>
    <script type="text/javascript" src="/common/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/common/js/modernizr-2.6.2.min.js"></script>
	<script type="text/javascript" src="/common/js/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="/common/js/sorttable.js"></script>
    <script type="text/javascript" src="/common/js/date.format.js"></script>
    <script type="text/javascript" src="/common/js/hippo/hippo.js"></script>

	<script type="text/javascript" src="/common/js/d3.js"></script>
    
    <!-- scatter chart -->
    <script type="text/javascript" src="/common/js/hippo/chart-scatter3.js"></script>
	<script type="text/javascript" src="/common/js/hippo/scatter/underscore-min.js"></script>
    <script type="text/javascript" src="/common/js/hippo/scatter/date.js"></script>
	<script type="text/javascript" src="/common/js/hippo/scatter/jquery.Class.js"></script>
	<script type="text/javascript" src="/common/js/hippo/scatter/jquery.dragToSelect.js"></script>
	<script type="text/javascript" src="/common/js/hippo/scatter/jquery.BigScatterChart.js"></script>
    
	<!-- server map -->    
    <script type="text/javascript" src="/common/js/hippo/chart-servermap.js"></script>
    <script type="text/javascript" src="/common/js/go.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/Point2D.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/intersection.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/canvas.roundRect.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/jquery.ServerMap.js"></script>
    
    <!-- requests list -->
    <script type="text/javascript" src="/common/js/hippo/chart-transactions.js"></script>
    
    <!-- help -->
    <script type="text/javascript" src="/common/js/hippo/help.js"></script>
    <script type="text/javascript" src="/common/js/hippo/message.js"></script>
</head>
<body>
<div class="container">
	<div class="row">
		<div class="span12">
		<table id="selectedBusinessTransactionsDetail" class="table table-bordered table-hover sortable">
			<thead>
			<tr>
			    <th class="sorttable_numeric">#</th>
			    <th class="sorttable_numeric">Time</th>
			    <th>TraceId</th>
			    <th class="sorttable_numeric">Res. Time (ms)</th>
			    <th>Exception</th>
			    <th>Application</th>
			    <th>AgentId</th>
			    <th>ClientIP</th>
			</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		</div>
	</div>
	<div id="loader">
		<img src="/common/images/ajaxloader.gif" />
	</div>
</div>
<script type="text/javascript">
$(document).ready(function () {
	if(!opener) {
		return;
	}
	
	var traces = opener.selectdTracesBox[window.name];
	delete opener.selectdTracesBox[window.name];
	
	if (!traces) {
		alert("Query not found.");
	}
	
	var query = [];
	var temp = {};
	for (var i = 0; i < traces.length; i++) {
		if (i > 0) {
			query.push("&");
		}
		query.push("tr");
		query.push(i);
		query.push("=");
		query.push(traces[i].traceId);
		
		query.push("&ti");
		query.push(i);
		query.push("=");
		query.push(traces[i].x)
		
		query.push("&re");
		query.push(i);
		query.push("=");
		query.push(traces[i].y)
	}
	
	$.post("/requestmetadata.hippo", query.join(""), function(d) {
		writeContents(d);
		$("#loader").hide();
	})
	.fail(function() {
		alert("Failed to fetching the request informations.");
	});
});

var writeContents = function(d) {
	$("#selectedBusinessTransactionsDetail TBODY").empty();
	
	var data = jQuery.parseJSON(d).metadata;
	
	var html = [];
	for (var i = 0; i < data.length; i++) {
		if(data[i].exception) {
			html.push("<tr class='error'>");
		} else {
			html.push("<tr>");
		}

		html.push("<td style='padding-right:5px;text-align:right'>");
		html.push(i + 1);
		html.push("</td>");

		html.push("<td sorttable_customkey='");
		html.push(data[i].startTime);
		html.push("'>");
		html.push(new Date(data[i].startTime).format("HH:MM:ss l"));
		html.push("</td>");
		
		html.push("<td>");
		html.push("<a href='#' onclick='openTrace(\"");
		html.push(data[i].traceId);
		html.push("\", \"");
		html.push(data[i].collectorAcceptTime);
		html.push("\");'>");
		html.push(data[i].traceId);
		html.push("</a>");
		html.push("</td>");

		html.push("<td style='padding-right:30px;text-align:right'>");
		html.push(formatNumber(data[i].elapsed));
		html.push("</td>");

		html.push("<td>");
		if (data[i].exception) {
			html.push(data[i].exception);
		}
		html.push("</td>");
		
		html.push("<td>");
		html.push(data[i].application);
		html.push("</td>");
		
		html.push("<td>");
		html.push(data[i].agentId);
		html.push("</td>");
		
		html.push("<td>");
		html.push("<a href='#' onclick=\"alert('not implemented. ip정보 조회 페이지로 연결.');\">");
		html.push(data[i].remoteAddr);
		html.push("</a>");
		html.push("</td>");

		html.push("</tr>");
	}

	$("#selectedBusinessTransactionsDetail TBODY").append(html.join(''));
}
</script>
</body>
</html>