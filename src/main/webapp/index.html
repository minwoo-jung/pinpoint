<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <title>HIPPO Web UI</title>

    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/common/css/hippo/hippo.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap-responsive.css" rel="stylesheet"/>
    <link href="/select2/select2-customized.css" rel="stylesheet"/>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/common/js/jquery/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/common/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/select2/select2.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v2.min.js?2.9.1"></script>
    <script type="text/javascript" src="/common/js/sankey/sankey.js"></script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
            </a>
			<a class="brand" href="/">HIPPO</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li><a data-toggle="modal" href="#myModal">Configuration</a></li>
                    <li><a href="http://devcafe.nhncorp.com/arcus" target="_blank">About</a></li>
                    <li><a href="#">Help</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal hide fade" id="myModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Configuration</h3>
    </div>
    <div class="modal-body">
        Configurations...
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <a href="#" class="btn btn-primary" onclick="saveNewChart();">Add to dashboard</a>
    </div>
</div>
<!-- END OF MODAL -->

<!-- MENU -->
<div class="container">
    <form class="form-inline">
        <select id="servers">
            <option value="emeroad-nhn-pc">emeroad-nhn-pc</option>
            <option value="TEST_TOMCAT11">TEST_TOMCAT11</option>
            <option value="TEST_TOMCAT22">TEST_TOMCAT22</option>
        </select>
        <input id="startdate" type="text" class="input-small" placeholder="StartDate" value="2012-01-01">
        <input id="starttime" type="text" class="input-small" placeholder="StartTime" value="01:00">
        ~
        <input id="enddate" type="text" class="input-small" placeholder="EndDate" value="2012-12-31">
        <input id="endtime" type="text" class="input-small" placeholder="EndTime" value="23:59">

        <button id="btnTraceRPC" type="button" class="btn btn-primary">Trace RPC !</button>
        <button id="btnTraceServer" type="button" class="btn btn-primary">Trace Server !</button>
    </form>

    <div class="row">
        <div class="span10">Application Flow Map</div>
    </div>
    <div class="row">
        <div class="span10">
            <p id="graph"></p>
        </div>
    </div>
    
    <div class="row">
        <div class="span10">Scatterplot</div>
    </div>
    <div class="row">
        <div class="span10">
            <p id="scatter"></p>
        </div>
    </div>

    <div class="row">
        <div class="span10">Business Transactions</div>
    </div>
    <div class="row">
        <div class="span10">
            <table id="businessTransactions" class="table table-bordered">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Calls</th>
                    <th>time(ms)</th>
                    <th>min time(ms)</th>
                    <th>max time(ms)</th>
                    <th>health</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="span10">Business Transactions Detail</div>
    </div>
    <div class="row">
        <div class="span10">
            <table id="businessTransactionsDetail" class="table table-bordered">
                <thead>
                <tr>
                    <th>#</th>
                    <th>TraceId</th>
                    <th>time (ms)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

</div>
<!-- END OF MENU -->


<script type="text/javascript">
function getStartTime() {
    return new Date($("#startdate").val() + " " + $("#starttime").val() + ":00").getTime();
}

function getEndTime() {
    return new Date($("#enddate").val() + " " + $("#endtime").val() + ":00").getTime();
}

function cleanupChart() {
    $("#graph").empty();
    $("#scatter").empty();
}

function cleanupTracesTable() {
    $("#businessTransactions TBODY").empty();
    $("#businessTransactionsDetail TBODY").empty();
}

function getChartData(chartType, callback) {
    var hosts = $("#servers").val();
	d3.json("/" + chartType + ".hippo?host=" + hosts + "&from=" + getStartTime() + "&to=" + getEndTime(), function(d) { callback(d); });
}

function drawSankeyChart(graphdata) {
	var margin = {
		    top:1,
		    right:1,
		    bottom:6,
		    left:1
		}, width = 1300 - margin.left - margin.right, height = 450 - margin.top - margin.bottom;

	var formatNumber = d3.format(",.0f"), format = function (d) {
	    	return formatNumber(d) + " Requests";
		}, color = d3.scale.category20();

    var svg = d3.select("#graph").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var sankey = d3.sankey().nodeWidth(15).nodePadding(10).size([ width, height ]);
    var path = sankey.link();

	sankey.nodes(graphdata.nodes).links(graphdata.links).layout(32);
	
	if (graphdata.nodes.length == 0) {
	    alert("no data");
	    return;
	}
	
	var link = svg.append("g").selectAll(".link").data(graphdata.links)
	        .enter().append("path")
	        .attr("class", "link")
	        .attr("d", path).style("stroke-width",function (d) {
	            return Math.max(1, d.dy);
	        }).sort(function (a, b) {
	            return b.dy - a.dy;
	        }).on("click", function (a, b) {
	            console.log(a);
	            console.log(b);
	        });
	
	link.append("title").text(
	        function (d) {
	            return d.source.name + " → " + d.target.name + "\n"
	                    + format(d.value);
	        });
	
	var node = svg.append("g").selectAll(".node").data(graphdata.nodes)
	        .enter().append("g").attr("class", "node").attr(
	        "transform",function (d) {
	            return "translate(" + d.x + "," + d.y + ")";
	        }).call(d3.behavior.drag().origin(function (d) {
	    return d;
	}).on("dragstart",function () {
	            this.parentNode.appendChild(this);
	        }).on("drag", dragmove));
	
	node.on("click", function (d) {
	    console.log(d);
	});
	
	node.append("rect").attr("height",function (d) {
	    return d.dy;
	}).attr("width", sankey.nodeWidth()).style("fill",function (d) {
	            return d.color = color(d.name.replace(/ .*/, ""));
	        }).style("stroke",function (d) {
	            return d3.rgb(d.color).darker(2);
	        }).append("title").text(function (d) {
	            return d.name + "\n" + format(d.value);
	        });
	
	node.append("text").attr("x", -6).attr("y",function (d) {
	    return d.dy / 2;
	}).attr("dy", ".35em").attr("text-anchor", "end").attr("transform",
	        null).text(function (d) {
	            return d.name;
	        }).filter(function (d) {
	            return d.x < width / 2;
	        }).attr("x", 6 + sankey.nodeWidth()).attr("text-anchor", "start");
	
	function dragmove(d) {
	    d3.select(this).attr(
	            "transform",
	            "translate("
	                    + d.x
	                    + ","
	                    + (d.y = Math.max(0, Math.min(height - d.dy,
	                    d3.event.y))) + ")");
	    sankey.relayout();
	    link.attr("d", path);
	}
}

var transactions;
var prevDetaildRow;

function showTransactionList(transactions) {
   var html = [];
   for (var i = 0; i < transactions.length; i++) {
       html.push("<tr>");

       html.push("<td>");
       html.push(i + 1);
       html.push("</td>");

       html.push("<td><a href='#' onclick='openTransactionDetails(");
       html.push(i);
       html.push(", this);'>");
       html.push(transactions[i].name);
       html.push("</a></td>");

       html.push("<td>");
       html.push(transactions[i].calls);
       html.push("</td>");

       html.push("<td>");
       html.push(transactions[i].time);
       html.push("</td>");

       html.push("<td>");
       html.push(transactions[i].minTime);
       html.push("</td>");

       html.push("<td>");
       html.push(transactions[i].maxTime);
       html.push("</td>");

       html.push("<td>");
       html.push(transactions[i].health);
       html.push("</td>");

       html.push("</tr>");
   }
   $("#businessTransactions TBODY").append(html.join(''));	
}

function openTransactionDetails(index, row) {
    if (prevDetaildRow != null) {
        prevDetaildRow.css({'background-color':'#FFFFFF'});
    }
    var currentRow = $(row).parent().parent();
    currentRow.css({'background-color':'#FFFF00'});
    prevDetaildRow = currentRow;

    $("#businessTransactionsDetail TBODY").empty();

    var traces = transactions[index].traces;
    var html = [];
    for (var i = 0; i < traces.length; i++) {
        html.push("<tr>");

        html.push("<td>");
        html.push(i + 1);
        html.push("</td>");

        html.push("<td><a href='#' onclick='openTrace(\"");
        html.push(traces[i].traceId);
        html.push("\");'>");
        html.push(traces[i].traceId);
        html.push("</a></td>");

        html.push("<td>");
        html.push(traces[i].time);
        html.push("</td>");

        html.push("</tr>");
    }
    $("#businessTransactionsDetail TBODY").append(html.join(''));
}

function drawScatter(data) {
	var margin = {top: 20, right: 20, bottom: 30, left: 40},
	    width = 960 - margin.left - margin.right,
	    height = 500 - margin.top - margin.bottom;

	var x = d3.time.scale().range([0, width]);
	var y = d3.scale.linear().range([height, 0]);
	var color = d3.scale.category10();

	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom");

	var yAxis = d3.svg.axis()
	    .scale(y)
	    .orient("left");
	
	var svg = d3.select("#scatter").append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  .append("g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	  //data.forEach(function(d) {
	  //  d.timestamp = +d.timestamp;
	  //  d.executionTime = +d.executionTime;
	  //});

	  x.domain(d3.extent(data, function(d) { return d.timestamp; }));//.nice();
	  y.domain(d3.extent(data, function(d) { return d.executionTime; }));//.nice();

	  svg.append("g")
	      .attr("class", "x axis")
	      .attr("transform", "translate(0," + height + ")")
	      .call(xAxis)
	    .append("text")
	      .attr("class", "label")
	      .attr("x", width)
	      .attr("y", -6)
	      .style("text-anchor", "end")
	      .text("Timestamp (HH:mm)");

	  svg.append("g")
	      .attr("class", "y axis")
	      .call(yAxis)
	    .append("text")
	      .attr("class", "label")
	      .attr("transform", "rotate(-90)")
	      .attr("y", 6)
	      .attr("dy", ".71em")
	      .style("text-anchor", "end")
	      .text("Execute time (ms)")

	  svg.selectAll(".dot")
	      .data(data)
	    .enter().append("circle")
	      .attr("class", "dot")
	      .attr("r", 3.5)
	      .attr("cx", function(d) { return x(d.timestamp); })
	      .attr("cy", function(d) { return y(d.executionTime); })
	      .style("fill", function(d) { return color(d.name); })
	      .on("click", function(d) { openTrace(d.traceId); });

	  var legend = svg.selectAll(".legend")
	      .data(color.domain())
	    .enter().append("g")
	      .attr("class", "legend")
	      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

	  legend.append("rect")
	      .attr("x", width - 18)
	      .attr("width", 18)
	      .attr("height", 18)
	      .style("fill", color);

	  legend.append("text")
	      .attr("x", width - 24)
	      .attr("y", 9)
	      .attr("dy", ".35em")
	      .style("text-anchor", "end")
	      .text(function(d) { return d; });
}

function openTrace(uuid) {
    window.open("/selectTransaction.hippo?traceId=" + uuid);
}

$(document).ready(function () {
    $("#servers").select2();
    
    $("#btnTraceRPC").click(function() { 
        cleanupChart();
        cleanupTracesTable();
        getChartData("flow", function(data) {
	        drawSankeyChart(data.graphdata);
	        showTransactionList(data.businessTransactions);
	        drawScatter(data.scatter);
        });
    });
    
    $("#btnTraceServer").click(function() { 
        cleanupChart();
        cleanupTracesTable();
        getChartData("flowserver", function(data) {
	        drawSankeyChart(data.graphdata);
	        showTransactionList(data.businessTransactions);
	        drawScatter(data.scatter);
        });
    });
});
</script>
</body>
</html>