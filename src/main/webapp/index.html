<!DOCTYPE html>
<html lang="en">
<head>
    <title>HIPPO</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap-responsive.css" rel="stylesheet"/>
    <link href="/common/css/hippo/hippo.css" rel="stylesheet"/>
    <link href="/common/css/datepicker.css" rel="stylesheet"/>
    <link href="/select2/select2-customized.css" rel="stylesheet"/>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/common/js/jquery/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/common/js/jquery/jquery-ui-1.8.18.custom.min.js"></script>
    <script type="text/javascript" src="/select2/select2.js"></script>
    <script type="text/javascript" src="/common/js/bootstrap.min.js"></script>
    
	<script type="text/javascript" src="/common/js/modernizr-2.6.2.min.js"></script>
	<script type="text/javascript" src="/common/js/bootstrap-datepicker.js"></script>
    
	<script type="text/javascript" src="/common/js/d3.js"></script>
	<script type="text/javascript" src="/common/js/d3.chart.js"></script>
	<script type="text/javascript" src="/common/js/d3.chart.scatter.js"></script>
    
    <script type="text/javascript" src="/common/js/sankey/sankey.js"></script>
    
    <script type="text/javascript" src="/common/js/hippo/chart-sankey.js"></script>
    <script type="text/javascript" src="/common/js/hippo/chart-scatter2.js"></script>
    <script type="text/javascript" src="/common/js/hippo/chart-springy.js"></script>
    <script type="text/javascript" src="/common/js/hippo/chart-tree.js"></script>
    <script type="text/javascript" src="/common/js/hippo/chart-transactions.js"></script>
    
    <script type="text/javascript" src="/common/js/date.format.js"></script>
    <script type="text/javascript" src="/common/js/hippo/hippo.js"></script>

    <script type="text/javascript" src="/common/js/hippo/servermap/springy.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/springyui.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/canvas.roundRect.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/hippoServerMap.js"></script>
</head>
<body>

<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
            </a>
			<a class="brand" href="/">HIPPO</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li><a href="http://devcafe.nhncorp.com/arcus" target="_blank">About</a></li>
                    <li><a data-toggle="modal" href="#myModal">Configuration</a></li>
                    <li><a data-toggle="modal" href="#myHelpModal">Help</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal hide fade" id="myModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Configuration</h3>
    </div>
    <div class="modal-body">
	Configuration.
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <!-- 
        <a href="#" class="btn btn-primary" onclick="saveNewChart();">Add to dashboard</a>
		-->
    </div>
</div>
<!-- END OF MODAL -->

<!-- HELP-MODAL -->
<div class="modal hide fade" id="myHelpModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Help</h3>
    </div>
    <div class="modal-body">
    <br/>E-mail to us. <a href="mailto:!hippo@nhn.com">!hippo@nhn.com</a><br/>
	<br/>Thank you.<br/><br/>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</div>
<!-- END OF HELP-MODAL -->

<!-- MODAL -->
<div class="modal hide fade" id="traceIdSelectModal" style="width:1200px; margin-left:-600px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Selected Traces</h3>
    </div>
    <div class="modal-body">
		<table id="selectedBusinessTransactionsDetail" class="table table-bordered table-hover">
			<thead>
			<tr>
			    <th>#</th>
			    <th>Time</th>
			    <th>TraceId</th>
			    <th>Res. Time (ms)</th>
			    <th>Exception</th>
			    <th>Application</th>
			    <th>AgentId</th>
			    <th>ClientIP</th>
			</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<ul id="selectedBusinessTransactionsDetailPager" class="pager">
			<li><a href="#">Previous</a></li>
			<li><a href="#">Next</a></li>
		</ul>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</div>
<!-- END OF MODAL -->


<!-- MENU -->
<div class="container">
	<form class="well well-small form-inline" id="search" onsubmit="return false;">
		<select id="application">
        	<option></option>
        </select>
		<div id="until" class="btn-group" data-toggle="buttons-radio">
			<button id="now" type="button" class="btn btn-primary active">now</button>
			<button id="specific" type="button" class="btn">select</button>
		</div>
		<input id="date" class="" maxlength="10" size="16" type="text" data-date-format="yyyy/mm/dd" style="text-align:center;width:80px" placeholder="yyyy/mm/dd" disabled>
		<input id="time" class="" maxlength="8" size="16" type="text" style="text-align:center;width:75px" placeholder="hh:mm:ss" disabled>
		
		<div id="period" class="btn-group" data-toggle="buttons-radio">
			<button type="button" value="5" class="btn btn-mini">5m</button>
			<button type="button" value="20" class="btn btn-mini btn-inverse active">20m</button>
			<button type="button" value="60" class="btn btn-mini">1h</button>
			<button type="button" value="360" class="btn btn-mini">6h</button>
			<button type="button" value="1440" class="btn btn-mini">1d</button>
			<button type="button" value="2880" class="btn btn-mini">2d</button>
		</div>
		
		<div class="pull-right">
			<label class="checkbox" style="margin:5px">
		    	<input id="auto_refresh" type="checkbox" style="margin-top:6px"> auto-refresh
		    </label>
	    </div>
	</form>


    <div class="row">
        <div class="span12">
			<ul class="nav nav-tabs" id="chartTabs">
				<li><a href="#Graph" data-toggle="tab">Server Graph</a></li>
				<li><a href="#Tree" data-toggle="tab">Server Tree</a></li>
				<li><a href="#Sankey" data-toggle="tab">Sankey Chart</a></li>
			</ul>
			
			<div class="tab-content">
				<div class="tab-pane active" id="Graph">
					<div class="indicator"><img src="/common/images/ajaxloader.gif"/></div>
					<div id="springygraph" style="width:1167px;height:700px;border:1px solid #DDDDDD;overflow:hidden;position:relative;display:none;"></div>
				</div>
				<div class="tab-pane" id="Tree" style="overflow:hidden;">
					Tree chart는 HIPPO개발자를 위한 차트입니다. (정식 버전에서 빠질 예정.)<br/>
					<p id="tree"></p>
				</div>
				<div class="tab-pane" id="Sankey">
					Sankey chart는 HIPPO개발자를 위한 차트입니다. (정식 버전에서 빠질 예정.)<br/>
					<p id="sankeygraph"></p>
				</div>
			</div>
		</div>
    </div>

    <div class="row">
        <div class="span12">
        	<br/><br/><br/>
        </div>
	</div>

    <div class="row">
        <div class="span12">
			<ul class="nav nav-tabs" id="transactionTabs">
				<li><a href="#ScatterChart" data-toggle="tab">Scatter Plot</a></li>
				<li><a href="#BusinessTransactionList" data-toggle="tab">Business Transactions</a></li>
			</ul>
			
			<div class="tab-content" style="min-height:550px;">
				<div class="tab-pane active" id="ScatterChart">
					<div class="indicator"><img src="/common/images/ajaxloader.gif"/></div>
					<p id="scatter"></p>
				</div>
				<div class="tab-pane" id="BusinessTransactionList">
		            <table id="businessTransactions" class="table table-bordered">
		                <thead>
		                <tr>
		                    <th>Name</th>
		                    <th>Calls</th>
		                    <th>Time(ms)</th>
		                    <th>Min Time(ms)</th>
		                    <th>Max Time(ms)</th>
		                </tr>
		                </thead>
		                <tbody>
		                </tbody>
		            </table>
		            
					<table id="businessTransactionsDetail" class="table table-bordered">
		                <thead>
		                <tr>
		                    <th>#</th>
		                    <th>Time</th>
		                    <th>TraceId</th>
		                    <th>Response Time (ms)</th>
		                </tr>
		                </thead>
		                <tbody>
		                </tbody>
		            </table>
				</div>
			</div>
		</div>
    </div>
    
    
	<div class="row">
		<div class="span12">
			<br/>
			<br/>
			<br/>
			<br/>
		</div>
	</div>
</div>
<!-- END OF MENU -->

<script type="text/javascript">
function openTrace(uuid, timestamp) {
    window.open("/selectTransaction.hippo?traceId=" + uuid + "&focusTimestamp=" + timestamp);
}

$(document).ready(function () {
	function getServerMapData(begin, end, callback) {
	    var application = $("#application").val();
		d3.json("/getServerMapData.hippo?application=" + application + "&from=" + begin + "&to=" + end, function(d) { callback(d); });
	}
	
	function getLastServerMapData(period, callback) {
	    var application = $("#application").val();
		d3.json("/getLastServerMapData.hippo?application=" + application + "&period=" + period, function(d) { callback(d); });
	}
	
	function getScatterData(begin, end, callback) {
	    var application = $("#application").val();
		d3.json("/getScatterData.hippo?application=" + application + "&from=" + begin + "&to=" + end + "&limit=5000", function(d) { callback(d); });
	}
	
	function getLastScatterData(period, callback) {
	    var application = $("#application").val();
		d3.json("/getLastScatterData.hippo?application=" + application + "&period=" + period + "&limit=5000", function(d) { callback(d); });
	}
	
	function getRealtimeScatterData(begin, callback) {
	    var application = $("#application").val();
		d3.json("/getRealtimeScatterData.hippo?application=" + application + "&from=" + begin + "&limit=5000", function(d) { callback(d); });
	}
	
	function getBusinessTransactionsData(begin, end, callback) {
	    var application = $("#application").val();
		d3.json("/getBusinessTransactionsData.hippo?application=" + application + "&from=" + begin + "&to=" + end, function(d) { callback(d); });
	}
	
	function getLastBusinessTransactionsData(period, callback) {
	    var application = $("#application").val();
		d3.json("/getLastBusinessTransactionsData.hippo?application=" + application + "&period=" + period, function(d) { callback(d); });
	}
	
	function getQueryPeriod() {
		return $("#period").find("button.active").val().split(",") * 1000 * 60;
	}
	
	function getQueryStartTime() {
		return getQueryEndTime() - getQueryPeriod();
	}

	function getQueryEndTime() {
 		var format = d3.time.format("%Y/%m/%d %H:%M:%S"),
			now = new Date(),
			input = format.parse($('#date').val() + ' ' + $('#time').val()) || now;
		
		if (input.getTime() > now.getTime()) {
			input = now;
		}
		return input.getTime();
	}
	
   	function setQueryDateToNow() {
	   	var date = new Date();
	   	var format_date = d3.time.format("%Y/%m/%d"),
	   		format_time = d3.time.format("%H:%M:%S");
	   	$('#date').val(format_date(date));
	   	$('#time').val(format_time(date));
   	}
	
	function showIndicator() {
		$(".indicator").show();
	}
	
	function hideIndicator() {
		$(".indicator").hide();
	}
	
	function isQueryFromNow() {
		return $(".btn#now.active").length > 0;
	}

   	$('#date').datepicker().on('changeDate', function(ev){
   		updateCharts();
	});
	
	$('#time').bind('focus', function(e){
		$(this).data("time", $(this).val());
	}).bind('blur', function(e){
		if ($(this).data("time") !== $(this).val()) {
	   		updateCharts();
		}
	});
	
	$('#until').delegate("button", "click", function(){
   		var $this = $(this);
   		
   		$this.siblings(".btn-primary").removeClass("btn-primary");
   		$this.addClass("btn-primary");
   		
   		if ($this.attr("id") === "now") {
   			$("#date").attr("disabled", "").val("");
   			$("#time").attr("disabled", "").val("");
	   		updateCharts();
   		} else {
   			setQueryDateToNow();
   			$("#date").attr("disabled", null);
   			$("#time").attr("disabled", null);
   		}
   	});
   	
   	$('#period').delegate("button", "click", function(){
   		var $this = $(this);
   		
   		$this.siblings(".btn-inverse").removeClass("btn-inverse active");
   		$this.addClass("btn-inverse active");
   		updateCharts();
   		$("#auto_refresh").trigger("change");
   	});
   	
   	var timer;
	$("#auto_refresh").bind("change", function(){
		if (this.checked) {
			if (timer != null) return;

			console.log("[auto-refresh] started.")
			
			clearInterval(timer);
			setQueryDateToNow();
		    updateCharts();
		    
		    var from = getQueryStartTime();
		    
			timer = setInterval(function() {
				setQueryDateToNow();
				console.log("[auto-refresh] fetching data from=" + from);
				
		        getRealtimeScatterData(from, function(data) {
		        	console.log("[auto-refresh] data fetched. " + data.scatter.length);
		        	console.log(getQueryStartTime());
		        	console.log(getQueryEndTime());
			        updateScatter(getQueryStartTime(), getQueryEndTime(), data.scatter, "#scatter");
		        	from = data.queryTo + 1;
		        });
			}, 3000);
		} else {
			clearInterval(timer);
			timer = null;
			console.log("[auto-refresh] stopped.")
		}
	});

	function cleanup() {
        $("#springygraph").empty();
        $("#sankeygraph").empty();
        $("#tree").empty();
        $("#scatter").empty();
        
        $("#businessTransactions TBODY").empty();
        $("#businessTransactionsDetail TBODY").empty();
        
        $('#chartTabs a:first').tab('show');
        $('#transactionTabs a:first').tab('show');
        
        $("#springygraph").css("display", "none");
	}
	
    function updateCharts() {
    	if($("#application").val() == "") {
    		alert("\n\nSelect an application, please.\n\n");
    		return true;
    	}

    	cleanup();
    	showIndicator();
    	
    	var serverMapCallback = function(data) {
        	if (data.graphdata.nodes.length == 0) {
	        	hideIndicator();
        	}
	        drawSpringy(data.graphdata, "#springygraph", 1100, 500);
	        drawTree(data.graphdata, "#tree", 1100, 500);
	        drawSankeyChart(data.graphdata, "#sankeygraph", 1100, 500);
        	hideIndicator();
        	
        	$("#springygraph").css("display", "");
        };
    	
    	var businessTransactionCallback = function(data) {
           	showTransactionList(data.businessTransactions);
    	};
    	
        var scatterCallback = function(data) {
        	// 처음 조회된 데이터를 그려준다.
	        updateScatter(getQueryStartTime(), getQueryEndTime(), data.scatter, "#scatter");
	        
	        if (data.scatter.length == 0) {
	        	return;
	        }
	        
	        // 데이터 조회가 추가로 필요한지 확인한다.
	        var lastTimeStamp = data.scatter[data.scatter.length - 1].timestamp;
	        
	        if (lastTimeStamp >= getQueryEndTime()) {
	        	return;
	        }
	        
	        var queryNext = true;
	        
	        var fetch = function() {
        		console.log("fetch scatter data");
        		clearInterval(scatterFetchTimer);
        		
				if(!queryNext || lastTimeStamp >= getQueryEndTime()) {
			        scatter.hideProgressbar();
					console.log("fetching scatter data finished.");
					return;
				}
				
	        	try {
	        		scatter.showProgressbar(lastTimeStamp + 1, getQueryEndTime());
	        		console.log("fetching scatter data.");
	        		
		        	getScatterData(lastTimeStamp + 1, getQueryEndTime(), function(data2) {
		        		console.log("fetched " + data2.scatter.length);
		        		scatter.hideProgressbar();
		    	        if (data2.scatter.length == 0) {
		    	        	queryNext = false;
		    	        	return;
		    	        }
				        updateScatter(getQueryStartTime(), getQueryEndTime(), data2.scatter, "#scatter");
		        		lastTimeStamp = data2.scatter[data2.scatter.length - 1].timestamp;
		        		scatterFetchTimer = setInterval(fetch, 200);
		        	});
	        	} catch(e) {
	        		console.log(e);
	        	}
	        }
	        var scatterFetchTimer = setInterval(fetch, 200);
        };
    	
        if (isQueryFromNow()) {
	        getLastServerMapData(getQueryPeriod(), serverMapCallback);
	        getLastBusinessTransactionsData(getQueryPeriod(), businessTransactionCallback);
	        drawScatter(getQueryStartTime(), getQueryEndTime(), "#scatter");
	        getLastScatterData(getQueryPeriod(), scatterCallback);
        } else {
	        getServerMapData(getQueryStartTime(), getQueryEndTime(), serverMapCallback);
	        getBusinessTransactionsData(getQueryStartTime(), getQueryEndTime(), businessTransactionCallback);
	        drawScatter(getQueryStartTime(), getQueryEndTime(), "#scatter");
	        getScatterData(getQueryStartTime(), getQueryEndTime(), scatterCallback);
        }
    }
	
    $("#application").select2({
		placeholder: "Select an application.",
	});
    
	$.getJSON("/applications.hippo", function(json) {
        var target = $("#application");
		$(json).each(function(i, e) {
            var html = [];
            html.push('<option value="');
            html.push(e);
            html.push('">');
            html.push(e);
            html.push('</option>');
            
            target.append(html.join(''));
		});
	});
	
	$("#selectedBusinessTransactionsDetailPager li").click(function() {
		alert("[NOT IMPLEMENTED]\n\nNOTE : 한꺼번에 많은 점을 선택했을 때 다 보여주지 않고.. 페이징?? 스크롤 페이징을 사용해도 될 것 같기도 하고...");
	});
	
	cleanup();
});
</script>
</body>
</html>