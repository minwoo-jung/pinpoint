<!DOCTYPE html>
<html lang="en">
<head>
    <title>PROBE</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap-responsive.css" rel="stylesheet"/>
    <link href="/common/css/hippo/hippo.css" rel="stylesheet"/>
    <link href="/common/css/hippo/sorttable.css" rel="stylesheet"/>
    <link href="/common/css/hippo/scatter.css" rel="stylesheet"/>
    <link href="/common/css/datepicker.css" rel="stylesheet"/>
    <link href="/select2/select2-customized.css" rel="stylesheet"/>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<!-- commons -->    
    <script type="text/javascript" src="/common/js/jquery/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/common/js/jquery/jquery-ui-1.10.2.js"></script>
    
    <script type="text/javascript" src="/select2/select2.js"></script>
    <script type="text/javascript" src="/common/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/common/js/modernizr-2.6.2.min.js"></script>
	<script type="text/javascript" src="/common/js/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="/common/js/sorttable.js"></script>
    <script type="text/javascript" src="/common/js/date.format.js"></script>
    <script type="text/javascript" src="/common/js/hippo/hippo.js"></script>

	<script type="text/javascript" src="/common/js/d3.js"></script>
    
    <!-- scatter chart -->
    <script type="text/javascript" src="/common/js/hippo/chart-scatter3.js"></script>
    <!-- 
	<script type="text/javascript" src="https://github.com/iamdenny/BigScatterChart/raw/master/js/chart-scatter3.js"></script>
	-->
	<script type="text/javascript" src="/common/js/hippo/scatter/underscore-min.js"></script>
    <script type="text/javascript" src="/common/js/hippo/scatter/date.js"></script>
	<script type="text/javascript" src="https://github.com/iamdenny/BigScatterChart/raw/master/js/jquery.Class.js"></script>
	<script type="text/javascript" src="/common/js/hippo/scatter/jquery.dragToSelect.js"></script>
	<!-- 
	<script type="text/javascript" src="https://github.com/iamdenny/BigScatterChart/raw/master/js/jquery.BigScatterChart.js"></script>
	 -->
	<script type="text/javascript" src="/common/js/hippo/scatter/jquery.BigScatterChart.js"></script>
    
	<!-- server map -->    
    <script type="text/javascript" src="/common/js/hippo/chart-springy.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/Point2D.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/intersection.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/springy.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/canvas.roundRect.js"></script>
    <script type="text/javascript" src="/common/js/hippo/servermap/hippoServerMap.js"></script>
    
    <!-- requests list -->
    <script type="text/javascript" src="/common/js/hippo/chart-transactions.js"></script>
    
    <!-- help -->
    <script type="text/javascript" src="/common/js/hippo/help.js"></script>
    <script type="text/javascript" src="/common/js/hippo/message.js"></script>
</head>
<body>

<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
			<a class="brand" href="/">PROBE</a>
            <form class="navbar-form pull-left">
         		<select id="application" disabled>
		        	<option>Loading...</option>
		        </select>
				<div id="until" class="btn-group" data-toggle="buttons-radio">
					<button id="now" type="button" class="btn btn-primary active">now</button>
					<button id="specific" type="button" class="btn">select</button>
				</div>
				<input id="date" class="" maxlength="10" size="16" type="text" data-date-format="yyyy/mm/dd" style="text-align:center;width:80px" placeholder="yyyy/mm/dd" disabled>
				<input id="time" class="" maxlength="8" size="16" type="text" style="text-align:center;width:75px" placeholder="hh:mm:ss" disabled>
				<div id="period" class="btn-group" data-toggle="buttons-radio">
					<button type="button" value="5" class="btn btn-mini">5m</button>
					<button type="button" value="20" class="btn btn-mini btn-inverse active">20m</button>
					<button type="button" value="60" class="btn btn-mini">1h</button>
					<button type="button" value="360" class="btn btn-mini">6h</button>
					<button type="button" value="1440" class="btn btn-mini">1d</button>
					<button type="button" value="2880" class="btn btn-mini">2d</button>
				</div>
            </form>
            <!-- 
			<div class="nav-collapse pull-right">
                <ul class="nav">
                    <li><a href="http://devcafe.nhncorp.com/arcus" target="_blank">About</a></li>
                    <li><a data-toggle="modal" href="#myModal">Configuration</a></li>
                    <li><a data-toggle="modal" href="#myHelpModal">Help</a></li>
                </ul>
            </div>
            -->
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal hide fade" id="myModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Configuration</h3>
    </div>
    <div class="modal-body">
	Configuration.
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <!-- 
        <a href="#" class="btn btn-primary" onclick="saveNewChart();">Add to dashboard</a>
		-->
    </div>
</div>
<!-- END OF MODAL -->

<!-- HELP-MODAL -->
<div class="modal hide fade" id="myHelpModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Help</h3>
    </div>
    <div class="modal-body">
    <br/>E-mail to us. <a href="mailto:!hippo@nhn.com">!hippo@nhn.com</a><br/>
	<br/>Thank you.<br/><br/>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</div>
<!-- END OF HELP-MODAL -->

<!-- MODAL -->
<div class="modal hide fade" id="traceIdSelectModal" style="width:1200px; margin-left:-600px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Selected Traces</h3>
    </div>
    <div class="modal-body">
		<table id="selectedBusinessTransactionsDetail" class="table table-bordered table-hover sortable">
			<thead>
			<tr>
			    <th class="sorttable_numeric">#</th>
			    <th class="sorttable_numeric">Time</th>
			    <th>TraceId</th>
			    <th class="sorttable_numeric">Res. Time (ms)</th>
			    <th>Exception</th>
			    <th>Application</th>
			    <th>AgentId</th>
			    <th>ClientIP</th>
			</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<ul id="selectedBusinessTransactionsDetailPager" class="pager">
			<li><a href="#">Previous</a></li>
			<li><a href="#">Next</a></li>
		</ul>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</div>
<!-- END OF MODAL -->

<div class="container" id="warningMessage"></div>

<!-- MENU -->
<div class="chart-container">
    <div class="chart-left">
		<div id="springygraph" class="servermap"></div>
	</div>
	<div class="chart-right">
		<h5 style="display:none;" id="scattercharttitle">Response scatter</h5>
		<div id="scatterchart"></div>
	</div>
</div>
<!-- END OF MENU -->

<script type="text/javascript">
$.extend($.tmpl.tag, {
    "var": {
        open: "var $1;"
    }
});
$.extend($.tmpl.tag, { "eval": { open: "$1;"} });

$(document).ready(function () {
   	$('#date').datepicker().on('changeDate', function(ev){
   		updateCharts();
	});
	
	$('#time').bind('focus', function(e){
		$(this).data("time", $(this).val());
	}).bind('blur', function(e){
		if ($(this).data("time") !== $(this).val()) {
	   		updateCharts();
		}
	});
	
	$('#until').delegate("button", "click", function(){
   		var $this = $(this);
   		
   		$this.siblings(".btn-primary").removeClass("btn-primary");
   		$this.addClass("btn-primary");
   		
   		if ($this.attr("id") === "now") {
   			$("#date").attr("disabled", "").val("");
   			$("#time").attr("disabled", "").val("");
	   		updateCharts();
   		} else {
   			setQueryDateToNow();
   			$("#date").attr("disabled", null);
   			$("#time").attr("disabled", null);
   		}
   	});
   	
   	$('#period').delegate("button", "click", function(){
   		var $this = $(this);
   		
   		$this.siblings(".btn-inverse").removeClass("btn-inverse active");
   		$this.addClass("btn-inverse active");
   		updateCharts();
   		$("#auto_refresh").trigger("change");
   	});
	
	// TODO 조회 버튼을 두 번 연속 눌렀을 때 앞서 수행되던 결과는 취소시켜야 함.
	// 예를 들어 1일치 조회하다가 모두 조회 되기 전에 30분 데이터 조회할 때...
    function updateCharts() {
		var applicationName = $("#application").val().split("@")[0];
    	if(applicationName == "") {
    		alert("\n\nSelect an application, please.\n\n");
    		return true;
    	}
    	
    	showServerMap(applicationName);
    	showResponseScatter(applicationName);
    }
    
	$.getJSON("/applications.hippo", function(json) {
        var target = $("#application");
		target.empty();
		$(json).each(function(i, e) {
            var html = [];
            html.push('<option value="');
            html.push(e.applicationName);
            html.push("@");
            html.push(e.code);
            html.push('"');
            if (json.length == 1) {
           		html.push(' selected>');
            } else {
           		html.push('>');
            }
            html.push(e.applicationName + "@" + e.serviceType);
            html.push('</option>');
            
            target.append(html.join(''));
            
            $("#application").attr("disabled", null);
            
            function format(state) {
            	var chunk = state.text.split("@");
            	if (chunk.length > 1) {
                	return "<img class='flag' src='/images/icons/" + chunk[1] + ".png'/> " + chunk[0];
            	} else {
            		return state;
            	}
            }
            
		    $("#application").select2({
				placeholder: "Select an application.",
				formatResult: format,
				formatSelection: format
			});
		    
		    // 임시.
		    $(".select2-container").css("top", "4px");
		});
	});
	
	$("#selectedBusinessTransactionsDetailPager li").click(function() {
		alert("[NOT IMPLEMENTED]\n\nNOTE : 한꺼번에 많은 점을 선택했을 때 다 보여주지 않고.. 페이징?? 스크롤 페이징을 사용해도 될 것 같기도 하고...");
	});
	
	$("#application").bind("change", function() {
		updateCharts();
	});
});
</script>
<script id="EdgeBox" type="text/x-jquery-tmpl">
	<div class="EdgeBox" style="position:absolute;border:1px solid #000;background:#fff;padding:5px 10px;-webkit-border-radius: 5px; ">
			Response statistics
			<i class="hippo-action-icon icon-question-sign" onclick="help(1004);"></i>
			<ul>
				{{var lastKey=''}}
				{{each(key, value) histogram}}
				<li>&lt;= ${key}ms : ${value}</li>
				{{eval lastKey=key}}
				{{/each}}
				<li>&gt; ${lastKey}ms : ${slow}</li>
				<li>Failed : ${error}</li>
			</ul>
			<hr/>
			<a href="#" onclick="alert('Sorry. Not implemented.');">Focus on passing transactions</a>
			<i class="hippo-action-icon icon-question-sign" onclick="help(1001);"></i>
			<br/><a href="#" onclick="alert('Sorry. Not implemented.\n query param = ${rawdata.sourceinfo.applicationName} -> ${rawdata.targetinfo.applicationName}');">Show Requests</a>
			<i class="hippo-action-icon icon-question-sign" onclick="help(1003);"></i>
		<button style="position:absolute;top:2px;right:2px;" onClick="$(this).parent().remove()">X</button>
	</div>
</script>
<script id="ServerBox" type="text/x-jquery-tmpl">
	<div class="ServerBox" style="position:absolute;border:1px solid #000;background:#fff;padding:5px 10px;-webkit-border-radius: 5px; ">
			Application Name
				<ul>
					<li>${label}</li>
				</ul>
			Application Type
				<ul>
					<li>${serviceType}</li>
				</ul>
			{{if hosts.length > 0}}
			Hosts
				<ul>
					{{each(key, value) hosts}}
						<li>
							<span class="label label-success">OK</span>
							${value}
							<a href="http://nsight.nhncorp.com/dashboard_server/${value.split(':')[0].replace('.nhnsystem.com','')}" target="_blank">(NSight)</a>
						</li>
					{{/each}}
				</ul>
			{{/if}}
			{{if agents.length > 0}}
			Server instances
				<ul>
					{{each(key, value) agents}}
					<li>
						<span class="label label-success">OK</span>
						${value.agentId}
						<a href="#" onclick="alert('Sorry. Not implemented.');">(Kuvasz)</a>
						<a href="#" onclick="alert('Sorry. Not implemented.');">(Tools)</a>
					</li>
					{{/each}}
				</ul>
			{{/if}}
			<hr/>
			<a href="#" onclick="alert('Sorry. Not implemented.');">Focus on passing transactions</a>
			<i class="hippo-action-icon icon-question-sign" onclick="help(1001);"></i>
			<br/><a href="#" onclick="showResponseScatter('${label}');">Response scatter chart</a>
			<i class="hippo-action-icon icon-question-sign" onclick="help(1003);"></i>
			<br/><a href="#" onclick="showRequests('${label}');">Show Requests</a>
			<i class="hippo-action-icon icon-question-sign" onclick="help(1002);"></i>
		<button style="position:absolute;top:2px;right:2px;" onClick="$(this).parent().remove()">X</button>
	</div>
</script>
<script id="ClientBox" type="text/x-jquery-tmpl">
	<div class="ServerBox" style="position:absolute;border:1px solid #000;background:#fff;padding:5px 10px;-webkit-border-radius: 5px; ">
			Clients
			Calls
				<ul>
					<li>Sorry. Not implemented.</li>
				</ul>
			<hr/>
			<a href="#" onclick="alert('Sorry. Not implemented.');">Show Requests</a>
		<button style="position:absolute;top:2px;right:2px;" onClick="$(this).parent().remove()">X</button>
	</div>
</script>
</body>
</html>