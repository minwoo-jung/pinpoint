<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <title>HIPPO Web UI</title>

    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/common/css/hippo/hippo.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="/common/css/bootstrap/bootstrap-responsive.css" rel="stylesheet"/>
    <link href="/select2/select2-customized.css" rel="stylesheet"/>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/common/js/jquery/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/common/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/select2/select2.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v2.min.js?2.9.1"></script>
    <script type="text/javascript" src="/common/js/sankey/sankey.js"></script>
    <script type="text/javascript" src="/common/js/hippo/hippo.js"></script>
    
    <script type="text/javascript" src="/common/js/springy/springy.js"></script>
    <script type="text/javascript" src="/common/js/springy/springyui.js"></script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
            </a>
			<a class="brand" href="/">HIPPO</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li><a data-toggle="modal" href="#myModal">Configuration</a></li>
                    <li><a href="http://devcafe.nhncorp.com/arcus" target="_blank">About</a></li>
                    <li><a href="#">Help</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal hide fade" id="myModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Configuration</h3>
    </div>
    <div class="modal-body">
	Configuration.
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <!-- 
        <a href="#" class="btn btn-primary" onclick="saveNewChart();">Add to dashboard</a>
		-->
    </div>
</div>
<!-- END OF MODAL -->

<!-- MODAL -->
<div class="modal hide fade" id="traceIdSelectModal" style="width:1000px; margin-left:-500px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Selected Traces</h3>
    </div>
    <div class="modal-body">
		<table id="selectedBusinessTransactionsDetail" class="table table-bordered">
			<thead>
			<tr>
			    <th>#</th>
			    <th>Time</th>
			    <th>TraceId</th>
			    <th>Response Time (ms)</th>
			    <th>Application</th>
			</tr>
			</thead>
			<tbody>
			</tbody>
       </table>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</div>
<!-- END OF MODAL -->


<!-- MENU -->
<div class="container">
    <form class="form-inline">
        <select id="application">
        	<option></option>
        </select>
        <input id="startdate" type="text" class="input-small" placeholder="StartDate" value="2012-11-06">
        <input id="starttime" type="text" class="input-small" placeholder="StartTime" value="10:00">
        ~
        <input id="enddate" type="text" class="input-small" placeholder="EndDate" value="2012-12-31">
        <input id="endtime" type="text" class="input-small" placeholder="EndTime" value="12:00">

		<!--
        <button id="btnTraceRPC" type="button" class="btn btn-primary">Trace RPC !</button>
        -->
        
        <button id="btnTraceServer" type="button" class="btn btn-primary">Trace Server !</button>
    </form>

    <div class="row">
        <div class="span10">Server map (tree)</div>
    </div>
    <div class="row">
        <div class="span10">
			<p id="tree"></p>
        </div>
    </div>
    
    <div class="row">
        <div class="span10">Server map (springy)</div>
    </div>
    <div class="row">
        <div class="span10">
			<canvas id="springygraph" width="960" height="10" />
        </div>
    </div>
    
    <div class="row">
        <div class="span10">Server map (sankey)</div>
    </div>
    <div class="row">
        <div class="span10">
            <p id="sankeygraph"></p>
        </div>
    </div>
    
    <div class="row">
        <div class="span10">Scatterplot</div>
    </div>
    <div class="row">
        <div class="span10">
            <p id="scatter"></p>
        </div>
    </div>

    <div class="row">
        <div class="span10">Business Transactions</div>
    </div>
    <div class="row">
        <div class="span10">
            <table id="businessTransactions" class="table table-bordered">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Calls</th>
                    <th>Time(ms)</th>
                    <th>Min Time(ms)</th>
                    <th>Max Time(ms)</th>
                    <th>Health</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="span10">Business Transactions Detail</div>
    </div>
    <div class="row">
        <div class="span10">
            <table id="businessTransactionsDetail" class="table table-bordered">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Time</th>
                    <th>TraceId</th>
                    <th>Response Time (ms)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

</div>
<!-- END OF MENU -->

<script type="text/javascript">
function getStartTime() {
	var date = $("#startdate").val().split("-");
	var time = $("#starttime").val().split(":");
	return new Date(date[0], date[1] - 1, date[2], time[0], time[1], 0, 0).getTime();
}

function getEndTime() {
	var date = $("#enddate").val().split("-");
	var time = $("#endtime").val().split(":");
	return new Date(date[0], date[1] - 1, date[2], time[0], time[1], 0, 0).getTime();
}

function getChartData(chartType, callback) {
    var application = $("#application").val();
	d3.json("/" + chartType + ".hippo?application=" + application + "&from=" + getStartTime() + "&to=" + getEndTime(), function(d) { callback(d); });
}

var transactionsCache;
var prevDetaildRow;

function showTransactionList(transactions) {
	transactionsCache = transactions;
	var html = [];
	for (var i = 0; i < transactions.length; i++) {
	    html.push("<tr>");
	
	    html.push("<td>");
	    html.push(i + 1);
	    html.push("</td>");
	
	    html.push("<td><a href='#' onclick='openTransactionDetails(");
	    html.push(i);
	    html.push(", this);'>");
	    html.push(transactions[i].name);
	    html.push("</a></td>");
	
	    html.push("<td class='calls'>");
	    html.push(transactions[i].calls);
	    html.push("</td>");
	
	    html.push("<td class='time'>");
	    html.push(transactions[i].avgTime.toFixed(0));
	    html.push("</td>");
	
	    html.push("<td class='time'>");
	    html.push(transactions[i].minTime);
	    html.push("</td>");
	
	    html.push("<td class='time'>");
	    html.push(transactions[i].maxTime);
	    html.push("</td>");
	
	    html.push("<td class='health'>");
	    html.push(transactions[i].health);
	    html.push("</td>");
	
	    html.push("</tr>");
	}
	$("#businessTransactions TBODY").append(html.join(''));	
}

function openTransactionDetails(index, row) {
    if (prevDetaildRow != null) {
        prevDetaildRow.css({'background-color':'#FFFFFF'});
    }
    var currentRow = $(row).parent().parent();
    currentRow.css({'background-color':'#FFFF00'});
    prevDetaildRow = currentRow;

    $("#businessTransactionsDetail TBODY").empty();

    var traces = transactionsCache[index].traces;
    var html = [];
    for (var i = 0; i < traces.length; i++) {
        html.push("<tr>");

        html.push("<td>");
        html.push(i + 1);
        html.push("</td>");
        
        html.push("<td>");
        html.push(new Date(traces[i].timestamp));
        html.push("</td>");

        html.push("<td><a href='#' onclick='openTrace(\"");
        html.push(traces[i].traceId);
        html.push("\");'>");
        html.push(traces[i].traceId);
        html.push("</a></td>");

        html.push("<td>");
        html.push(traces[i].executionTime);
        html.push("</td>");

        html.push("</tr>");
    }
    $("#businessTransactionsDetail TBODY").append(html.join(''));
}

$(document).ready(function () {
    var date = new Date();
    $("#startdate").val(date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate());

    var min = date.getMinutes();
    $("#starttime").val(date.getHours() + ":" + ((min < 10) ? (60 - (10 - min)) : (min - 10)));
	
    $("#application").select2({
		placeholder: "Select a application.",
	});
    
    $("#btnTraceRPC").click(function() { 
    	// cleanup chart
        $("#springygraph").empty();
        $("#sankeygraph").empty();
        $("#tree").empty();
        
        // cleanup transaction tables
        $("#businessTransactions TBODY").empty();
        $("#businessTransactionsDetail TBODY").empty();
        
        getChartData("flow", function(data) {
        	if (data.graphdata.nodes.length == 0) {
        	    alert("no data");
        	    return;
        	}
	        drawSpringy(data.graphdata, "#springygraph", 960, 500);
	        drawTree(data.graphdata, "#tree", 960, 500);
	        drawSankeyChart(data.graphdata, "#sankeygraph", 960, 500);
	        showTransactionList(data.businessTransactions);
	        drawScatter(data.scatter, "#scatter");
        });
    });
    
    $("#btnTraceServer").click(function() {
    	// cleanup chart
        $("#springygraph").empty();
        $("#sankeygraph").empty();
        $("#tree").empty();
        $("#scatter").empty();
        
        // cleanup transaction tables
        $("#businessTransactions TBODY").empty();
        $("#businessTransactionsDetail TBODY").empty();
        
        getChartData("flowserver", function(data) {
        	if (data.graphdata.nodes.length == 0) {
        	    alert("no data");
        	    return;
        	}
        	
	        drawSpringy(data.graphdata, "#springygraph", 960, 500);
	        drawTree(data.graphdata, "#tree", 960, 500);
	        drawSankeyChart(data.graphdata, "#sankeygraph", 960, 500);
	        showTransactionList(data.businessTransactions);
	        drawScatter(data.scatter, "#scatter");
        });
    });
    
	$.getJSON("/applications.hippo", function(json) {
        var target = $("#application");
		$(json).each(function(i, e) {
            var html = [];
            html.push('<option value="');
            html.push(e);
            html.push('">');
            html.push(e);
            html.push('</option>');
            
            target.append(html.join(''));
		});
	});
});
</script>
</body>
</html>