<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context" xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <import resource="classpath:job/span/applicationContext-datasource.xml"/>
    <import resource="classpath:job/span/applicationContext-dao-config.xml"/>

    <context:annotation-config/>

    <context:component-scan
        base-package="com.navercorp.pinpoint.common.server.util"/>

    <bean id="propertyConfigurer" class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>classpath:/job/span/jdbc.properties</value>
            </list>
        </property>
    </bean>

    <bean id="tcpDispatchHandlerWrapper" class="com.navercorp.pinpoint.collector.receiver.thrift.DispatchHandlerFactoryBean">
        <constructor-arg ref="tcpDispatchHandler"/>
        <constructor-arg ref="handlerManager"/>
    </bean>

    <bean id="tcpDispatchHandler" class="com.navercorp.pinpoint.flink.job.span.stat.receiver.TcpDispatchHandler"/>
    <bean id="handlerManager" class="com.navercorp.pinpoint.collector.manage.HandlerManager"/>

    <util:properties id="span_stat_properties" location="classpath:/job/span/spanStat.properties"/>
    <bean id="flinkConfiguration" class="com.navercorp.pinpoint.flink.config.FlinkConfiguration">
        <property name="properties" ref="span_stat_properties"/>
    </bean>
    <bean id="tcpReceiverConfig" class="com.navercorp.pinpoint.collector.config.AgentBaseDataReceiverConfiguration">
        <constructor-arg ref="span_stat_properties"/>
        <constructor-arg ref="deprecatedConfig"/>
    </bean>
    <bean id="deprecatedConfig" class="com.navercorp.pinpoint.collector.config.DeprecatedConfiguration">
        <constructor-arg ref="span_stat_properties"/>
    </bean>

    <bean id="tcpSourceFunction" class="com.navercorp.pinpoint.flink.job.span.stat.receiver.TcpSourceFunction"/>

    <bean id="spanStatHandler" class="com.navercorp.pinpoint.flink.job.span.stat.receiver.SpanStatHandler"/>

    <bean id="tcpReceiver" class="com.navercorp.pinpoint.collector.receiver.thrift.TCPReceiverBean" lazy-init="true">
        <property name="bindIp" value="#{tcpReceiverConfig.bindIp}"/>
        <property name="bindPort" value="#{tcpReceiverConfig.bindPort}"/>
        <property name="acceptorProvider" ref="spanAcceptorProvider"/>
        <property name="dispatchHandler" ref="tcpDispatchHandlerWrapper"/>
        <property name="executor" ref="flinkWorker"/>
        <property name="tcpPacketHandlerFactory" ref="flinkPacketHandlerFactory"/>
    </bean>


    <bean id="flinkWorker" class="com.navercorp.pinpoint.collector.receiver.thrift.ExecutorFactoryBean">
        <property name="corePoolSize" value="#{tcpReceiverConfig.workerThreadSize}"/>
        <property name="maxPoolSize" value="#{tcpReceiverConfig.workerThreadSize}"/>
        <property name="queueCapacity" value="#{tcpReceiverConfig.workerQueueSize}"/>
        <property name="rejectedExecutionHandler" ref="discardPolicy"/>
        <property name="threadNamePrefix" value="Pinpoint-Flink-Worker-"/>
        <property name="daemon" value="true"/>
        <property name="waitForTasksToCompleteOnShutdown" value="true"/>
        <property name="awaitTerminationSeconds" value="10"/>
        <property name="preStartAllCoreThreads" value="true"/>
        <property name="registry" value="#{tcpReceiverConfig.workerMonitorEnable ? metricRegistry : null}"/>
        <property name="logRate" value="1"/>
    </bean>
    <bean id="flinkPacketHandlerFactory" class="com.navercorp.pinpoint.flink.receiver.FlinkPacketHandlerFactory">
        <constructor-arg index="0" ref="flinkHeaderTBaseSerializerFactory"/>
        <constructor-arg index="1" ref="flinkHeaderTBaseDeserializerFactory"/>
    </bean>
    <bean id="spanAcceptorProvider" class="com.navercorp.pinpoint.collector.receiver.thrift.PinpointServerAcceptorProvider">
        <property name="channelFilter" ref="channelFilter"/>
    </bean>
    <bean id="discardPolicy" class="java.util.concurrent.ThreadPoolExecutor.DiscardPolicy"/>

    <bean id="flinkHeaderTBaseSerializerFactory" class="com.navercorp.pinpoint.thrift.io.HeaderTBaseSerializerFactory">
        <constructor-arg index="0" value="#{flinkSpanStatTBaseLocator.typeLocator}"/>
    </bean>
    <bean id="flinkHeaderTBaseDeserializerFactory" class="com.navercorp.pinpoint.thrift.io.FlinkHeaderTBaseDeserializerFactory">
        <constructor-arg index="0" value="#{flinkSpanStatTBaseLocator.typeLocator}"/>
    </bean>
    <bean id="channelFilter" class="com.navercorp.pinpoint.collector.receiver.thrift.AddressFilterAdaptor">
        <constructor-arg ref="addressFilter"/>
    </bean>

    <bean id="addressFilter" class="com.navercorp.pinpoint.common.server.util.IgnoreAddressFilter">
        <constructor-arg value="#{flinkConfiguration.l4IpList}"/>
    </bean>

    <bean id="flinkServerRegister" class="com.navercorp.pinpoint.flink.cluster.FlinkServerRegister" lazy-init="true">
        <constructor-arg index="0" ref="flinkConfiguration"/>
        <constructor-arg index="1" value="/pinpoint-cluster/flink-span"/>
    </bean>

    <bean id="metricRegistry" class="com.codahale.metrics.MetricRegistry"/>

    <bean id="flinkSpanStatTBaseLocator" class="com.navercorp.pinpoint.thrift.io.FlinkSpanStatTBaseLocator"/>

    <bean id="tbaseFlatMapper" class="com.navercorp.pinpoint.flink.job.span.stat.process.TBaseFlatMapper"/>

    <bean id="spanStatService" class="com.navercorp.pinpoint.flink.job.span.stat.service.SpanStatService"/>

    <bean id="spanStatAgentService" class="com.navercorp.pinpoint.flink.job.span.stat.service.SpanStatAgentService">
        <constructor-arg index="0" ref="spanStatAgentDao"/>
    </bean>
    <bean id="spanStatAgentDao" class="com.navercorp.pinpoint.flink.job.span.stat.dao.mysql.SpanStatAgentDaoImpl">
        <constructor-arg index="0" ref="sqlSessionTemplate"/>
    </bean>

</beans>